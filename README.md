# ItemSetGroup

Omeka S 用のモジュールで、複数のアイテムセットを「グループ」として選択・表示するためのブロックを提供します。既存モジュールの良いところを統合し、サイト表示と管理UXを強化しています。

- Selection ブロック: トップページや任意のページで、指定したアイテムセットのサムネイルとタイトル・説明をグリッドで表示
- 代表アイテム/メディア: アイテムセットに代表アイテム・メディアを設定し、サムネイルとして自動的に利用（任意設定／自動反映）
- サイドバー選択 UX 改善: 管理サイドバーでの子アイテム選択時に、不要な詳細遷移を抑止し、意図したクリックで即選択
- プレースホルダー: サムネイルが用意できない場合でもプレースホルダーを表示してレイアウトを保全

## 統合元（機能的な継承）
本モジュールは、以下の3モジュールに相当する機能を統合・再設計しています（コードは独自実装）。

1. GroupsBrowseRoute（カスタムのグループ用ルーティング/表示の下支え）
   - 以前はグループ親用の特別なルートやフォールバック表示を別モジュールで提供
   - 本モジュールでは Selection ブロック内にフォールバック描画を内包し、別モジュール不要化
2. ItemSetPrimaryItem（アイテムセットの代表アイテム/メディアの保持とサムネイル割当）
   - item_set_primary_item テーブルに代表アイテム/メディア（任意）を保存
   - 代表メディアのサムネイルをアイテムセットのサムネイルへ自動割当（未設定時のみ）
   - Advancedタブに代表UIを常時表示（未定義環境でも確実に表示・保存可能）
3. ThematicSelection / Selection 派生（セクション表示ブロック）
   - ブロックフォームにて、複数のアイテムセットを選択・並べ替え
   - 子アイテムを任意に1件まで表示（リンク先などの補助）
   - サイト/公開のフィルタを尊重しつつ、グループ親セットは候補から除外

これらの要素を、依存を最小化しつつ1モジュールに統合しました。

## 主な機能
- Selection ブロック
  - 見出し・説明（HTML）・「もっと見る」リンク設定
  - アイテムセット最大12件のグリッド表示
  - タイトル/説明の表示ON/OFFと説明の最大文字数トリム
  - サムネイル解決: 代表メディア → アイテムセットの標準サムネ → プレースホルダー
  - 子アイテム（任意1件）のタイトル/リンク表示
  - 候補の並び: セレクタ候補はID昇順、フォームの先頭に“(none)”
- 管理UX
  - 代表アイテム/メディア UI を Advanced タブへ常時注入
  - 子アイテム選択サイドバー: 親セットとその子セットで絞り込み、クリックの詳細遷移を抑止
  - 「子アイテムをクリア」ボタンなどの補助導線
- データ
  - item_set_primary_item テーブル（item_set_id, primary_item_id, primary_media_id）
  - インストール/アンインストールでテーブル作成/削除

## インストール
1. リリースZipをダウンロードして `modules/ItemSetGroup` に展開（フォルダ名は ItemSetGroup）
2. Omeka S 管理画面 → モジュール → ItemSetGroup を有効化

開発中はGitクローンでも可: `modules/ItemSetGroup` にチェックアウトし、Omeka S管理で有効化します。

### 依存
- Omeka S 4.x 系を想定
- 他モジュールへのハード依存はありません（機能は本モジュール内で完結）

## 使い方
1. 代表アイテム/メディアの設定（任意）
   - アイテムセット編集 → Advanced タブ
   - 代表アイテムを選択し、必要に応じて代表メディアを選択
   - 保存時に、アイテムセットのサムネイルが未設定なら代表メディアのサムネイルを自動割当
2. Selection ブロックの追加
   - サイトページ編集 → ブロックを追加 → 「Item Set Group selection」
   - グローバル設定（見出し/説明/もっと見る）
   - 各行でアイテムセット、任意でサムネイル上書き（アセット/URL）や子アイテムを設定
   - 注意: グループ親（dcterms:isPartOf の参照先になっているセット）は候補に表示されません

## 互換性と移行
- 旧 GroupsBrowseRoute モジュールの機能は不要です
  - 本モジュールにフォールバック描画を内包しており、グループ親の特別ルートがなくてもブロックが欠けません
  - 既に GroupsBrowseRoute をお使いの場合は、無効化/アンインストールを推奨（特別なデータは保持していません）
- 旧 ItemSetPrimaryItem 相当のデータ
  - 本モジュールが `item_set_primary_item` を管理します
  - 既存に同名テーブルがある場合は、同スキーマであればそのまま利用されます

## 設定詳細（実装メモ）
- 候補生成時の除外
  - DBの value/property を参照して `dcterms:isPartOf` の value_resource_id を親ID集合として抽出
  - サイト登録＆公開のアイテムセット一覧から、親IDに該当するものを除外
- サイドバーでのクリック抑止
  - capture フェーズの複数イベント（pointer/mouse/click/keydown）をフックし、詳細画面への遷移をブロックして即選択
  - sidebar-content-loaded フックで href と data 属性を除去し、独自クリックハンドラを設定

## 開発者向け
- フォルダ構成
  - Module.php
  - asset/css, asset/img
  - config/module.config.php, module.ini
  - src/Controller, src/Site/BlockLayout, src/View/Helper
  - view/common/block-layout
- サムネイル解決ヘルパ
  - `ItemSetGroup\View\Helper\ItemSetPrimaryThumb`（IIIF優先、URL/HTML出力対応）

## ライセンス
MIT License。詳細は `LICENSE` を参照してください。
