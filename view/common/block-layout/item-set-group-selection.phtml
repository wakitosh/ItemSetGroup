<?php
$escape = $this->plugin('escapeHtml');
$translate = $this->plugin('translate');
$hyperlink = $this->plugin('hyperlink');
?>
<div class="ts-preview-block">

  <?php if (!empty($this->heading)): ?>
  <div class="ts-preview-header">
    <h3 class="ts-preview-title"><?php echo $escape($this->heading); ?></h3>
  </div>
  <?php endif; ?>

  <?php if (!empty($this->description)): ?>
  <div class="ts-preview-description">
    <?php echo $this->description; ?>
  </div>
  <?php endif; ?>

  <ul class="resources resource-grid ts-preview-grid">
    <?php foreach ($this->items as $it): ?>
      <?php
        $res = $it['resource'] ?? null;
        $thumb = (string) ($it['thumb'] ?? '');
  $title = (string) ($it['title'] ?? '');
  $titleHtml = isset($it['titleHtml']) ? (string) $it['titleHtml'] : $title;
        $desc = (string) ($it['desc'] ?? '');
  $child = (string) ($it['child'] ?? '');
  $childHtml = isset($it['childHtml']) ? (string) $it['childHtml'] : $child;
        $childUrl = (string) ($it['childUrl'] ?? '');
        $url = isset($it['url']) ? (string) $it['url'] : '';
        $parts = [];
        if ($thumb) {
          $attrs = 'class="thumbnail" loading="lazy" decoding="async" alt="" onload="this.parentNode.classList.add(\'is-loaded\')" onerror="this.parentNode.classList.add(\'is-loaded\')"';
          $parts[] = '<span class="thumb-frame"><img src="' . $escape($thumb) . '" ' . $attrs . ' /></span>';
        }
        if (!empty($this->showTitle) && $titleHtml !== '') {
          $parts[] = '<span class="resource-name">' . $titleHtml . '</span>';
        }
        if (!$parts) {
          $blank = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
          $attrs = 'class="thumbnail" loading="lazy" decoding="async" alt="" onload="this.parentNode.classList.add(\'is-loaded\')" onerror="this.parentNode.classList.add(\'is-loaded\')"';
          $parts[] = '<span class="thumb-frame"><img src="' . $blank . '" ' . $attrs . ' /></span>';
        }
        $linkContent = implode('', $parts);
      ?>
      <li class="resource ts-resource">
        <div class="resource-meta ts-resource-meta">
          <?php if ($res): ?>
            <?php if ($url): ?>
              <?php echo $hyperlink->raw($linkContent, $url, ['class' => 'resource-link']); ?>
            <?php else: ?>
              <?php echo $res->linkRaw($linkContent, null, ['class' => 'resource-link']); ?>
            <?php endif; ?>
          <?php else: ?>
            <span class="resource-link"><?php echo $linkContent; ?></span>
          <?php endif; ?>
          <?php if ($childHtml !== ''): ?>
            <div class="ts-representative-item">
              <?php
                $iconSvg = '<svg class="ts-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" aria-hidden="true" focusable="false"><title>840_ch_f</title><rect width="48" height="48" fill="none"/><circle cx="24" cy="24" r="18" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="4"/><polyline points="16.09 25.49 21.62 31.02 32.91 19.73" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="4"/></svg>';
                $childLinkContent = $iconSvg . '<span class="ts-representative-item-text">' . $childHtml . '</span>';
                echo $hyperlink->raw($childLinkContent, $childUrl ?: '#', ['class' => 'ts-representative-item-link']);
              ?>
            </div>
          <?php endif; ?>
          <?php if (!empty($this->showDesc) && $desc !== ''): ?>
            <div class="description"><?php echo $escape($desc); ?></div>
          <?php endif; ?>
        </div>
      </li>
    <?php endforeach; ?>
  </ul>

  <?php if (!empty($this->moreUrl) && !empty($this->moreText)): ?>
    <div class="ts-preview-footer">
      <?php echo $this->hyperlink($this->moreText, $this->moreUrl, ['class' => 'ts-more-link']); ?>
    </div>
  <?php endif; ?>

</div>
