<?php
$escape = $this->plugin('escapeHtml');
$translate = $this->plugin('translate');
$hyperlink = $this->plugin('hyperlink');
?>
<div class="ts-preview-block">

  <?php if (!empty($this->heading)): ?>
  <div class="ts-preview-header">
    <h3 class="ts-preview-title"><?php echo $escape($this->heading); ?></h3>
  </div>
  <?php endif; ?>

  <?php if (!empty($this->description)): ?>
  <div class="ts-preview-description">
    <?php echo $this->description; ?>
  </div>
  <?php endif; ?>

  <ul class="resources resource-grid ts-preview-grid">
    <?php foreach ($this->items as $it): ?>
      <?php
        $res = $it['resource'] ?? null;
        $thumb = (string) ($it['thumb'] ?? '');
  $title = (string) ($it['title'] ?? '');
  $titleHtml = isset($it['titleHtml']) ? (string) $it['titleHtml'] : $title;
        $desc = (string) ($it['desc'] ?? '');
  $child = (string) ($it['child'] ?? '');
  $childHtml = isset($it['childHtml']) ? (string) $it['childHtml'] : $child;
        $childUrl = (string) ($it['childUrl'] ?? '');
        $url = isset($it['url']) ? (string) $it['url'] : '';
        $parts = [];
        if ($thumb) {
          $attrs = 'class="thumbnail" loading="lazy" decoding="async" alt="" onload="this.parentNode.classList.add(\'is-loaded\')" onerror="this.parentNode.classList.add(\'is-loaded\')"';
          $parts[] = '<span class="thumb-frame"><img src="' . $escape($thumb) . '" ' . $attrs . ' /></span>';
        }
        if (!empty($this->showTitle) && $titleHtml !== '') {
          $parts[] = '<span class="resource-name">' . $titleHtml . '</span>';
        }
        if (!$parts) {
          $blank = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
          $attrs = 'class="thumbnail" loading="lazy" decoding="async" alt="" onload="this.parentNode.classList.add(\'is-loaded\')" onerror="this.parentNode.classList.add(\'is-loaded\')"';
          $parts[] = '<span class="thumb-frame"><img src="' . $blank . '" ' . $attrs . ' /></span>';
        }
        $linkContent = implode('', $parts);
      ?>
      <li class="resource ts-resource">
        <div class="resource-meta ts-resource-meta">
          <?php if ($res): ?>
            <?php if ($url): ?>
              <?php echo $hyperlink->raw($linkContent, $url, ['class' => 'resource-link']); ?>
            <?php else: ?>
              <?php echo $res->linkRaw($linkContent, null, ['class' => 'resource-link']); ?>
            <?php endif; ?>
          <?php else: ?>
            <span class="resource-link"><?php echo $linkContent; ?></span>
          <?php endif; ?>
          <?php if ($childHtml !== ''): ?>
            <div class="ts-representative-item">
              <?php
                // Replace icon with the provided SVG (scales via viewBox and CSS .ts-icon)
                $iconSvg = '<svg class="ts-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" aria-hidden="true" focusable="false"><path d="M512 144C520.8 144 528 151.2 528 160L528 416C528 424.8 520.8 432 512 432L192 432C183.2 432 176 424.8 176 416L176 160C176 151.2 183.2 144 192 144L512 144zM192 96C156.7 96 128 124.7 128 160L128 416C128 451.3 156.7 480 192 480L512 480C547.3 480 576 451.3 576 416L576 160C576 124.7 547.3 96 512 96L192 96zM272 208C272 190.3 257.7 176 240 176C222.3 176 208 190.3 208 208C208 225.7 222.3 240 240 240C257.7 240 272 225.7 272 208zM412.7 211.8C408.4 204.5 400.5 200 392 200C383.5 200 375.6 204.5 371.3 211.8L324.8 290.8L307.6 266.2C303.1 259.8 295.8 256 287.9 256C280 256 272.7 259.8 268.2 266.2L212.2 346.2C207.1 353.5 206.4 363.1 210.6 371C214.8 378.9 223.1 384 232 384L472 384C480.6 384 488.6 379.4 492.8 371.9C497 364.4 497 355.2 492.7 347.8L412.7 211.8zM80 216C80 202.7 69.3 192 56 192C42.7 192 32 202.7 32 216L32 512C32 547.3 60.7 576 96 576L456 576C469.3 576 480 565.3 480 552C480 538.7 469.3 528 456 528L96 528C87.2 528 80 520.8 80 512L80 216z"/></svg>';
                $childLinkContent = $iconSvg . '<span class="ts-representative-item-text">' . $childHtml . '</span>';
                echo $hyperlink->raw($childLinkContent, $childUrl ?: '#', ['class' => 'ts-representative-item-link']);
              ?>
            </div>
          <?php endif; ?>
          <?php if (!empty($this->showDesc) && $desc !== ''): ?>
            <div class="description"><?php echo $escape($desc); ?></div>
          <?php endif; ?>
        </div>
      </li>
    <?php endforeach; ?>
  </ul>

  <?php if (!empty($this->moreUrl) && !empty($this->moreText)): ?>
    <div class="ts-preview-footer">
      <?php echo $this->hyperlink($this->moreText, $this->moreUrl, ['class' => 'ts-more-link']); ?>
    </div>
  <?php endif; ?>

</div>
